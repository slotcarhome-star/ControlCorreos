<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Car Home - Gestor Inteligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-10">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="users" class="h-6 w-6 text-yellow-400"></i>
                <div>
                    <h1 class="text-lg font-bold leading-none">Slot Car Home</h1>
                    <div class="flex items-center gap-1 text-xs mt-1" id="connection-badge">
                        <i data-lucide="loader-2" class="h-3 w-3 animate-spin"></i> 
                        <span id="connection-text">Iniciando...</span>
                    </div>
                </div>
            </div>
            <button id="btn-toggle-view" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition border border-slate-700 flex items-center gap-2 text-sm font-medium">
                <i data-lucide="settings" class="h-4 w-4"></i> 
                <span id="view-text">Configuraci√≥n</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-3xl mx-auto p-4 relative">
        
        <!-- VISTA: BANDEJA -->
        <div id="view-bandeja" class="flex flex-col gap-6 fade-in">
            
            <!-- ALERTA MODO LOCAL -->
            <div id="local-mode-alert" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="hard-drive" class="h-5 w-5 text-blue-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Modo Local Activo:</strong> Los datos viven en este navegador.
                            <br><span class="text-xs text-blue-500">Usa "Guardar Backup" antes de cambiar de dispositivo o subir a GitHub.</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- PANEL ACCIONES MASIVAS (NUEVO) -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-5 rounded-2xl shadow-lg text-white">
                <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wide mb-3 flex items-center gap-2">
                    <i data-lucide="mail-plus" class="h-4 w-4"></i> Env√≠o Masivo
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Krono Personal -->
                    <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-300 text-sm">Krono Personal</span>
                            <span id="count-kp" class="bg-blue-900 text-blue-200 text-xs px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.appActions.copyMassEmails('kronoPersonal')" class="flex-1 bg-white text-slate-900 text-xs font-bold py-2 rounded hover:bg-blue-50 transition flex justify-center items-center gap-1">
                                <i data-lucide="copy" class="h-3 w-3"></i> Copiar Emails
                            </button>
                            <button onclick="window.appActions.sendMassEmail('kronoPersonal')" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded hover:bg-blue-500 transition flex justify-center items-center gap-1">
                                <i data-lucide="send" class="h-3 w-3"></i> Redactar
                            </button>
                        </div>
                    </div>
                    <!-- Krono Dual -->
                    <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-purple-300 text-sm">KronoDual</span>
                            <span id="count-kd" class="bg-purple-900 text-purple-200 text-xs px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.appActions.copyMassEmails('kronoDual')" class="flex-1 bg-white text-slate-900 text-xs font-bold py-2 rounded hover:bg-purple-50 transition flex justify-center items-center gap-1">
                                <i data-lucide="copy" class="h-3 w-3"></i> Copiar Emails
                            </button>
                            <button onclick="window.appActions.sendMassEmail('kronoDual')" class="flex-1 bg-purple-600 text-white text-xs font-bold py-2 rounded hover:bg-purple-500 transition flex justify-center items-center gap-1">
                                <i data-lucide="send" class="h-3 w-3"></i> Redactar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORMULARIO -->
            <div class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-yellow-400">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                    <i data-lucide="user-plus" class="h-4 w-4"></i> Nuevo Cliente
                </h2>
                <form id="form-add" class="flex flex-col gap-3">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="flex-1">
                            <input type="email" id="input-email" placeholder="Email (ej: cliente@gmail.com)" required
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none transition">
                        </div>
                        <div class="flex-1">
                            <input type="text" id="input-nombre" placeholder="Nombre (Opcional)"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none transition">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <span class="text-sm font-bold text-gray-500 pl-2">Interesado en:</span>
                        <select id="input-programa" class="flex-1 bg-transparent border-none p-2 focus:ring-0 font-medium text-slate-800 cursor-pointer outline-none">
                            <option value="kronoPersonal">üèÅ Krono Personal</option>
                            <option value="kronoDual">‚ö° KronoDual (1vs1)</option>
                            <option value="tracksTelemetry">üìä Tracks Telemetry</option>
                        </select>
                    </div>

                    <button type="submit" class="mt-1 bg-yellow-400 text-yellow-900 font-bold px-6 py-3 rounded-lg hover:bg-yellow-500 transition shadow-sm flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="h-5 w-5"></i> A√±adir a la Base de Datos
                    </button>
                </form>
            </div>

            <!-- LISTA -->
            <div>
                <div class="flex justify-between items-end mb-3 px-1">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        Cola de Env√≠os 
                        <span id="counter-pending" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">0</span>
                    </h2>
                    
                    <!-- BARRA DE HERRAMIENTAS DE DATOS -->
                    <div class="flex gap-2" id="data-tools">
                        <input type="file" id="input-import-json" accept=".json" class="hidden">
                        
                        <button id="btn-backup-json" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-2 py-1 rounded transition flex items-center gap-1 font-medium" title="Descargar Copia de Seguridad para llevar a GitHub">
                            <i data-lucide="save" class="h-3 w-3"></i> Backup
                        </button>
                        
                        <button id="btn-restore-json" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-2 py-1 rounded transition flex items-center gap-1 font-medium" title="Cargar Copia de Seguridad">
                            <i data-lucide="upload" class="h-3 w-3"></i> Restaurar
                        </button>

                        <button id="btn-export-csv" class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 transition hidden font-medium ml-2">
                            <i data-lucide="file-spreadsheet" class="h-3 w-3"></i> Excel
                        </button>
                        
                        <button id="btn-clear-all" class="text-xs text-red-400 hover:text-red-600 flex items-center gap-1 hidden ml-1">
                            <i data-lucide="eraser" class="h-3 w-3"></i>
                        </button>
                    </div>
                </div>

                <div id="contacts-list" class="grid gap-3"></div>
                
                <div id="empty-state" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hidden">
                    <p class="text-gray-400 font-medium">Base de datos vac√≠a.</p>
                    <p class="text-sm text-gray-400 mt-1">A√±ade un cliente o Restaura una Copia de Seguridad.</p>
                </div>
            </div>
        </div>

        <!-- VISTA: CONFIGURACI√ìN -->
        <div id="view-config" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 pb-0">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="settings" class="h-5 w-5"></i> Editor de Plantillas
                    </h2>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="template-tabs">
                        <button data-template="kronoPersonal" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-blue-600 text-white shadow-md">
                            <i data-lucide="monitor" class="h-4 w-4"></i> Krono Personal
                        </button>
                        <button data-template="kronoDual" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <i data-lucide="zap" class="h-4 w-4"></i> KronoDual
                        </button>
                        <button data-template="tracksTelemetry" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <i data-lucide="activity" class="h-4 w-4"></i> Tracks Telemetry
                        </button>
                    </div>
                </div>
                
                <div class="p-6 pt-4">
                    <div class="mb-2 text-xs text-gray-500 font-medium uppercase tracking-wider" id="editor-label">
                        Editando carta para: Krono Personal
                    </div>
                    <textarea id="template-editor" class="w-full h-80 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 text-sm leading-relaxed font-mono resize-none"></textarea>
                    
                    <button id="btn-save-templates" class="mt-4 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition flex justify-center items-center gap-2">
                        <i data-lucide="save" class="h-5 w-5"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gray-800 text-white p-4 border-b flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2" id="modal-title"></h3>
                <button id="btn-close-modal" class="text-gray-400 hover:text-white transition"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <div class="border-b pb-2">
                    <span class="text-gray-500 text-xs font-bold uppercase mr-2">Para:</span>
                    <span id="modal-recipient" class="text-blue-600 bg-blue-50 px-2 py-1 rounded font-mono text-sm"></span>
                </div>
                <div id="modal-body" class="bg-gray-50 p-4 rounded-lg border text-sm whitespace-pre-wrap font-sans text-gray-700 leading-relaxed"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3 flex-wrap">
                <button id="btn-cancel-modal" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition text-sm font-medium">Cancelar</button>
                <button id="btn-copy-text" class="px-4 py-2 bg-white border text-gray-700 rounded-lg hover:bg-gray-50 transition flex items-center gap-2 text-sm shadow-sm font-medium">
                    <i data-lucide="copy" class="h-4 w-4"></i> Copiar
                </button>
                <button id="btn-send-mail" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg flex items-center gap-2 text-sm">
                    <i data-lucide="external-link" class="h-4 w-4"></i> Abrir Gmail
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SISTEMA DE ALMACENAMIENTO H√çBRIDO ---
        let dbMode = 'LOCAL'; // Por defecto, asume local hasta que se demuestre lo contrario
        let firebaseDb = null;
        let firebaseUser = null;
        let appId = 'slot-car-app';

        // DATOS EXTRA√çDOS DE CAPTURAS
        const IMPORTED_CONTACTS = [
            // --- NUEVOS DETECTADOS EN CAPTURAS ---
            {nombre: "Pepe Moren", email: "prismasal123@gmail.com", programa: "kronoDual"},
            {nombre: "Rompe 4", email: "alejandrohg77@gmail.com", programa: "kronoDual"},
            
            // --- KRONO PERSONAL ---
            {nombre: "Nacho Arur", email: "arceurrea@gmail.com", programa: "kronoPersonal"},
            {nombre: "P Joao", email: "p.joao1@hotmail.com", programa: "kronoPersonal"},
            {nombre: "J L R M", email: "jl.romu1@gmail.com", programa: "kronoPersonal"},
            {nombre: "Sifri Perez", email: "sergi_sifri@hotmail.com", programa: "kronoPersonal"},
            {nombre: "Juan calomarde martinez", email: "jcm_686@hotmail.com", programa: "kronoPersonal"},
            {nombre: "Juan Antonio Jimenez", email: "juanjimez61@gmail.com", programa: "kronoPersonal"},
            {nombre: "Albert Ruiz", email: "lbrtruiz1@gmail.com", programa: "kronoPersonal"},
            {nombre: "Miguel Carrero Sanchez", email: "miguel.carrerosanchez@gmail.com", programa: "kronoPersonal"},
            {nombre: "Javier Recaredo Benito", email: "recaredoz@gmail.com", programa: "kronoPersonal"},
            {nombre: "Enrique Lopez Molina", email: "lopezmolinakike@gmail.com", programa: "kronoPersonal"},
            {nombre: "Mora", email: "mora.prados@gmail.com", programa: "kronoPersonal"},
            {nombre: "Lucio Ruiz", email: "oicul1967@gmail.com", programa: "kronoPersonal"},
            {nombre: "Piolet Piolet", email: "piolet686@gmail.com", programa: "kronoPersonal"},
            {nombre: "Rafa T.", email: "key_34@yahoo.es", programa: "kronoPersonal"},
            {nombre: "Luis Martinez", email: "luanmare@gmail.com", programa: "kronoPersonal"},
            {nombre: "Ignacio Cuadrado", email: "icuadradogutierrez@gmail.com", programa: "kronoPersonal"},
            {nombre: "Dani Subirana Miquel", email: "subiroff@proton.me", programa: "kronoPersonal"},
            {nombre: "JUAN LORENZO LANDE", email: "juanlandeirac@gmail.com", programa: "kronoPersonal"},
            {nombre: "marcelo perez", email: "guerreros3@msn.com", programa: "kronoPersonal"},
            {nombre: "Jos√© M¬™ Rodr√≠guez Ingelmo", email: "ingelmojmr@gmail.com", programa: "kronoPersonal"},
            {nombre: "Chema", email: "chema.pinilla@gmail.com", programa: "kronoPersonal"},
            {nombre: "Jose Rodrigo Poggio", email: "poggius@gmail.com", programa: "kronoPersonal"},
            {nombre: "Carlos Lopez", email: "carlos.g.lopez@gmail.com", programa: "kronoPersonal"},
            
            // --- KRONO DUAL ---
            {nombre: "Jordi Perez", email: "jordipr11@gmail.com", programa: "kronoDual"},
            {nombre: "Victor Guil", email: "vguilgaibar@gmail.com", programa: "kronoDual"},
            {nombre: "Jose Jochezka", email: "jochezka@hotmail.com", programa: "kronoDual"},
            {nombre: "MARCIAL MELGOSA", email: "massi.mc@hotmail.com", programa: "kronoDual"},
            {nombre: "FRANCISCO JAVIER", email: "javi678acaro@gmail.com", programa: "kronoDual"},
            {nombre: "Francisco Granado Veiga", email: "gatsuow@gmail.com", programa: "kronoDual"},
            {nombre: "Vicente Coves Escolano", email: "labolse@hotmail.com", programa: "kronoDual"},
            {nombre: "Manu Casta√±o", email: "albanuel123@gmail.com", programa: "kronoDual"}, // Email corregido seg√∫n captura
            {nombre: "Eduard gil abellan", email: "eduart555@hotmail.com", programa: "kronoDual"},
            {nombre: "Fernando BARCA ROBLES", email: "barca.robles.f@gmail.com", programa: "kronoDual"},
            {nombre: "Jaime Gonzalvez Oliva", email: "jaimegonzalvezoliva@gmail.com", programa: "kronoDual"},
            {nombre: "Jacinto Pardo", email: "jacingas@gmail.com", programa: "kronoDual"},
            {nombre: "Miquel Casals Tutau", email: "miquelcasals02@gmail.com", programa: "kronoDual"},

            // --- MULTI-PROGRAMA (Javier, JP, Albert) ---
            {nombre: "Javier Arcediano", email: "ediskrotas1987@gmail.com", programa: "kronoPersonal"},
            {nombre: "Javier Arcediano", email: "ediskrotas1987@gmail.com", programa: "kronoDual"},
            
            {nombre: "J.P", email: "pixelesybugs@gmail.com", programa: "kronoPersonal"},
            {nombre: "J.P", email: "pixelesybugs@gmail.com", programa: "kronoDual"},
            
            {nombre: "Albert", email: "albertclosa@yahoo.es", programa: "kronoDual"},
            {nombre: "Albert", email: "albertclosa@yahoo.es", programa: "tracksTelemetry"}
        ].map(c => ({
            ...c,
            id: 'imp_' + Math.random().toString(36).substr(2, 9),
            asunto: `Info: ${c.programa === 'kronoPersonal' ? 'Krono Personal' : c.programa === 'kronoDual' ? 'KronoDual' : 'Tracks Telemetry'}`,
            fecha: 'Importado',
            estado: 'pendiente',
            createdAt: { seconds: Date.now() / 1000 } // timestamp simulado
        }));

        // Valores por defecto
        const DEFAULT_PLANTILLAS = {
            kronoPersonal: `Hola,\n\n¬°Gracias por tu inter√©s en KRONO PERSONAL!\n\nEs el gestor de tiempos ideal para entrenamientos individuales...`,
            kronoDual: `Hola,\n\n¬°Qu√© bueno que te intereses por KRONODUAL!\n\nEste es nuestro sistema dise√±ado para competiciones 1vs1...`,
            tracksTelemetry: `Hola,\n\nGracias por contactar sobre TRACKS TELEMETRY.\n\nEst√°s a punto de llevar el an√°lisis de tu pista...`
        };

        // Estado App
        let contactos = [];
        let plantillas = { ...DEFAULT_PLANTILLAS };
        let currentTemplateKey = 'kronoPersonal';
        let currentContactForMail = null;

        // Referencias DOM
        const dom = {
            badgeText: document.getElementById('connection-text'),
            badgeIcon: document.querySelector('#connection-badge i'),
            badgeContainer: document.getElementById('connection-badge'),
            localAlert: document.getElementById('local-mode-alert'),
            list: document.getElementById('contacts-list'),
            empty: document.getElementById('empty-state'),
            counter: document.getElementById('counter-pending'),
            editor: document.getElementById('template-editor'),
            viewBandeja: document.getElementById('view-bandeja'),
            viewConfig: document.getElementById('view-config'),
            modal: document.getElementById('modal-overlay'),
            inputImport: document.getElementById('input-import-json'),
            countKp: document.getElementById('count-kp'),
            countKd: document.getElementById('count-kd')
        };

        // --- INICIALIZACI√ìN ---
        async function initApp() {
            lucide.createIcons();

            // 1. Detectar si hay configuraci√≥n de Firebase (Entorno Canvas)
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    console.log("Detectado entorno Cloud/Canvas");
                    const config = JSON.parse(__firebase_config);
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    firebaseDb = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            firebaseUser = user;
                            dbMode = 'CLOUD';
                            setConnectionStatus('cloud');
                            loadDataCloud();
                        }
                    });
                    return; // Salimos, dejamos que Firebase maneje todo
                } catch (e) {
                    console.warn("Fallo al conectar Firebase, pasando a Local", e);
                }
            }
            
            // 2. Si no hay config o fall√≥ -> MODO LOCAL AUTOM√ÅTICO
            dbMode = 'LOCAL';
            setConnectionStatus('local');
            loadDataLocal();
        }

        // --- GESTI√ìN DE UI ESTADO ---
        function setConnectionStatus(type) {
            if (type === 'cloud') {
                dom.badgeText.textContent = "Cloud Sync Activo";
                dom.badgeContainer.className = "flex items-center gap-1 text-xs text-green-400 mt-1";
                dom.badgeIcon.setAttribute('data-lucide', 'cloud');
                dom.localAlert.classList.add('hidden');
            } else {
                dom.badgeText.textContent = "Modo Local (GitHub)";
                dom.badgeContainer.className = "flex items-center gap-1 text-xs text-blue-400 mt-1";
                dom.badgeIcon.setAttribute('data-lucide', 'hard-drive');
                dom.localAlert.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // --- CAPA DE DATOS (CLOUD) ---
        function loadDataCloud() {
            // Contactos
            onSnapshot(collection(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts'), (snap) => {
                contactos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // SI EST√Å VAC√çO, CARGAR DATOS IMPORTADOS
                if(contactos.length === 0) {
                   IMPORTED_CONTACTS.forEach(c => addContactCloud(c));
                } else {
                   contactos.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                   render();
                }
            });
            // Plantillas
            onSnapshot(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'settings', 'templates'), (snap) => {
                if (snap.exists()) plantillas = snap.data();
                if (!dom.viewConfig.classList.contains('hidden')) dom.editor.value = plantillas[currentTemplateKey] || "";
            });
        }

        async function addContactCloud(data) {
            await addDoc(collection(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts'), {
                ...data, createdAt: serverTimestamp()
            });
        }

        async function updateContactCloud(id, data) {
            await updateDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts', id), data);
        }

        async function deleteContactCloud(id) {
            await deleteDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts', id));
        }

        async function saveTemplatesCloud() {
            await setDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'settings', 'templates'), plantillas);
        }

        // --- CAPA DE DATOS (LOCAL) ---
        function loadDataLocal() {
            // Cargar de localStorage
            const localContacts = localStorage.getItem('slot_contacts');
            const localTemplates = localStorage.getItem('slot_templates');
            
            if (localContacts) {
                contactos = JSON.parse(localContacts);
            } else {
                // PRIMERA CARGA: USAR DATOS IMPORTADOS DE CAPTURAS
                contactos = [...IMPORTED_CONTACTS];
                saveLocal();
            }

            if (localTemplates) plantillas = JSON.parse(localTemplates);
            
            render();
        }

        function saveLocal() {
            localStorage.setItem('slot_contacts', JSON.stringify(contactos));
            localStorage.setItem('slot_templates', JSON.stringify(plantillas));
            render();
        }

        async function addContactLocal(data) {
            const newContact = { 
                ...data, 
                id: 'local_' + Date.now(), 
                createdAt: { seconds: Date.now() / 1000 } 
            };
            contactos.unshift(newContact);
            saveLocal();
        }

        async function updateContactLocal(id, data) {
            contactos = contactos.map(c => c.id === id ? { ...c, ...data } : c);
            saveLocal();
        }

        async function deleteContactLocal(id) {
            contactos = contactos.filter(c => c.id !== id);
            saveLocal();
        }

        async function saveTemplatesLocal() {
            saveLocal(); // Las plantillas ya se actualizan en la variable global antes de llamar a esto
        }

        // --- RENDER ---
        function render() {
            dom.list.innerHTML = '';
            const pendientes = contactos.filter(c => c.estado === 'pendiente');
            dom.counter.textContent = pendientes.length;
            
            // Actualizar Contadores Masivos
            const kp = contactos.filter(c => c.programa === 'kronoPersonal' && c.estado === 'pendiente');
            const kd = contactos.filter(c => c.programa === 'kronoDual' && c.estado === 'pendiente');
            dom.countKp.textContent = kp.length;
            dom.countKd.textContent = kd.length;

            // Botones Herramientas
            const btnClear = document.getElementById('btn-clear-all');
            const btnExport = document.getElementById('btn-export-csv');

            if(contactos.length > 0) {
                dom.empty.classList.add('hidden');
                btnClear.classList.remove('hidden');
                btnExport.classList.remove('hidden');
            } else {
                dom.empty.classList.remove('hidden');
                btnClear.classList.add('hidden');
                btnExport.classList.add('hidden');
            }

            contactos.forEach(c => {
                const el = document.createElement('div');
                const info = getProgramInfo(c.programa);
                const isDone = c.estado === 'procesado';
                
                el.className = `bg-white rounded-xl p-5 shadow-sm border-l-4 transition-all ${isDone ? 'border-green-400 bg-gray-50 opacity-60' : 'border-slate-800'}`;
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg text-gray-900 leading-none">${escapeHtml(c.nombre)}</h3>
                                <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${info.color}">${info.name}</span>
                            </div>
                            <p class="text-sm text-gray-500 font-mono">${escapeHtml(c.email)}</p>
                        </div>
                        <span class="text-xs font-bold text-gray-400">${c.fecha}</span>
                    </div>
                    ${isDone ? `
                        <div class="flex items-center gap-2 text-green-700 font-bold bg-green-100 p-2 rounded-lg justify-center border border-green-200 text-sm">
                            <i data-lucide="check-circle" class="h-4 w-4"></i> Procesado
                        </div>
                    ` : `
                        <div class="flex gap-2">
                            <button onclick="window.appActions.prepare('${c.id}')" class="flex-1 bg-slate-800 text-white py-2.5 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-slate-900 shadow-md transition text-sm">
                                <i data-lucide="send" class="h-4 w-4"></i> Generar
                            </button>
                            <button onclick="window.appActions.delete('${c.id}')" class="w-10 flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg hover:text-red-500 hover:bg-red-50 transition">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    `}
                `;
                dom.list.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- HANDLERS UI ---
        document.getElementById('form-add').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const nombre = document.getElementById('input-nombre').value;
            const programa = document.getElementById('input-programa').value;
            
            if(!email) return;

            const data = {
                email, nombre: nombre || 'Usuario', programa,
                asunto: `Info: ${getProgramInfo(programa).name}`,
                fecha: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                estado: 'pendiente'
            };

            if (dbMode === 'CLOUD') await addContactCloud(data);
            else await addContactLocal(data);

            e.target.reset();
            document.getElementById('input-programa').value = programa; // Mantener selecci√≥n
        });

        // Toggle Vistas
        const btnView = document.getElementById('btn-toggle-view');
        btnView.addEventListener('click', () => {
            const isConfig = !dom.viewConfig.classList.contains('hidden');
            if (isConfig) {
                dom.viewConfig.classList.add('hidden');
                dom.viewBandeja.classList.remove('hidden');
                document.getElementById('view-text').textContent = "Configuraci√≥n";
                btnView.innerHTML = `<i data-lucide="settings" class="h-4 w-4"></i> <span id="view-text">Configuraci√≥n</span>`;
            } else {
                dom.viewBandeja.classList.add('hidden');
                dom.viewConfig.classList.remove('hidden');
                document.getElementById('view-text').textContent = "Volver";
                btnView.innerHTML = `<i data-lucide="arrow-left" class="h-4 w-4"></i> <span id="view-text">Volver</span>`;
                loadEditor(currentTemplateKey);
            }
            lucide.createIcons();
        });

        // Tabs Config
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => loadEditor(btn.dataset.template));
        });

        function loadEditor(key) {
            currentTemplateKey = key;
            // Estilos Tabs
            document.querySelectorAll('.tab-btn').forEach(b => {
                const active = b.dataset.template === key;
                b.className = `tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${active ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
            });
            dom.editor.value = plantillas[key] || "";
            document.getElementById('editor-label').textContent = `Editando: ${getProgramInfo(key).name}`;
            lucide.createIcons();
        }

        // Guardar Plantillas
        document.getElementById('btn-save-templates').addEventListener('click', async () => {
            plantillas[currentTemplateKey] = dom.editor.value;
            if (dbMode === 'CLOUD') await saveTemplatesCloud();
            else await saveTemplatesLocal();
            
            alert('Plantilla guardada correctamente');
        });

        // Bot√≥n Limpiar Todo
        document.getElementById('btn-clear-all').addEventListener('click', async () => {
            if(confirm("¬øEst√°s seguro de borrar TODA la lista?")) {
                if(dbMode === 'LOCAL') {
                    contactos = [];
                    saveLocal();
                } else {
                    alert("En modo Cloud, por seguridad, borra uno a uno.");
                }
            }
        });

        // --- SISTEMA BACKUP / IMPORTAR / EXPORTAR ---
        
        // 1. Exportar CSV (Excel)
        document.getElementById('btn-export-csv').addEventListener('click', () => {
            if (contactos.length === 0) { alert("No hay datos."); return; }
            
            const headers = ["ID", "Nombre", "Email", "Programa", "Fecha", "Estado"];
            const escapeCSV = (f) => `"${String(f || "").replace(/"/g, '""')}"`;

            const rows = contactos.map(c => [
                c.id, c.nombre, c.email, getProgramInfo(c.programa).name, c.fecha, c.estado
            ]);
            const csvContent = [headers.join(","), ...rows.map(r => r.map(escapeCSV).join(","))].join("\n");
            
            downloadFile(csvContent, `contactos_slot_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
        });

        // 2. BACKUP JSON (Guardar todo)
        document.getElementById('btn-backup-json').addEventListener('click', () => {
            const backup = {
                version: 1,
                date: new Date().toISOString(),
                contacts: contactos,
                templates: plantillas
            };
            const jsonContent = JSON.stringify(backup, null, 2);
            downloadFile(jsonContent, `BACKUP_SLOT_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
        });

        // 3. RESTAURAR JSON (Cargar todo)
        document.getElementById('btn-restore-json').addEventListener('click', () => {
            if(contactos.length > 0 && !confirm("Esto SOBRESCRIBIR√Å tus contactos actuales. ¬øSeguir?")) return;
            dom.inputImport.click();
        });

        dom.inputImport.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if(data.contacts && Array.isArray(data.contacts)) {
                        contactos = data.contacts;
                        if(data.templates) plantillas = data.templates;
                        
                        if(dbMode === 'LOCAL') {
                            saveLocal();
                            alert("‚úÖ Backup restaurado correctamente. Tus datos est√°n listos.");
                        } else {
                            // En modo Cloud es m√°s complejo, lo simulamos recargando memoria
                            // Idealmente habr√≠a que subir uno a uno a Firebase, pero por seguridad lo dejamos en memoria/local
                            alert("Backup cargado en memoria. Para guardar permanentemente en Cloud, contacta con el administrador.");
                        }
                        render();
                    } else {
                        alert("‚ùå El archivo no parece un backup v√°lido.");
                    }
                } catch(err) {
                    alert("‚ùå Error al leer el archivo: " + err.message);
                }
                dom.inputImport.value = ''; // Reset
            };
            reader.readAsText(file);
        });

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- ACCIONES GLOBALES (Window) ---
        window.appActions = {
            delete: async (id) => {
                if(confirm("¬øEliminar?")) {
                    if (dbMode === 'CLOUD') await deleteContactCloud(id);
                    else await deleteContactLocal(id);
                }
            },
            prepare: (id) => {
                const c = contactos.find(x => x.id === id);
                if(!c) return;
                currentContactForMail = c;
                
                document.getElementById('modal-title').textContent = c.asunto;
                document.getElementById('modal-recipient').textContent = c.email;
                document.getElementById('modal-body').textContent = plantillas[c.programa] || "";
                dom.modal.classList.remove('hidden');
            },
            // NUEVO: FUNCIONES MASIVAS
            copyMassEmails: (type) => {
                const targets = contactos.filter(c => c.programa === type && c.estado === 'pendiente');
                if(targets.length === 0) { alert("No hay destinatarios pendientes para este programa."); return; }
                const emails = targets.map(c => c.email).join('; ');
                navigator.clipboard.writeText(emails);
                alert(`Copiados ${targets.length} emails al portapapeles. P√©galos en CCO.`);
            },
            sendMassEmail: (type) => {
                const targets = contactos.filter(c => c.programa === type && c.estado === 'pendiente');
                if(targets.length === 0) { alert("No hay destinatarios pendientes."); return; }
                
                const emails = targets.map(c => c.email).join(',');
                const info = getProgramInfo(type);
                const body = plantillas[type] || "Hola, adjuntamos informaci√≥n.";
                
                // Intento abrir cliente de correo con BCC
                const link = `mailto:?bcc=${emails}&subject=${encodeURIComponent("Info: " + info.name)}&body=${encodeURIComponent(body)}`;
                
                window.open(link, '_blank');
                
                if(confirm("¬øMarcar todos estos contactos como procesados?")) {
                    targets.forEach(async c => {
                         if (dbMode === 'CLOUD') await updateContactCloud(c.id, { estado: 'procesado' });
                         else await updateContactLocal(c.id, { estado: 'procesado' });
                    });
                }
            }
        };

        // Modal Actions
        const closeModal = () => dom.modal.classList.add('hidden');
        document.getElementById('btn-close-modal').addEventListener('click', closeModal);
        document.getElementById('btn-cancel-modal').addEventListener('click', closeModal);

        document.getElementById('btn-copy-text').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('modal-body').textContent);
            alert("Copiado!");
        });

        document.getElementById('btn-send-mail').addEventListener('click', async () => {
            if (!currentContactForMail) return;
            const link = `mailto:${currentContactForMail.email}?subject=${encodeURIComponent(currentContactForMail.asunto)}&body=${encodeURIComponent(document.getElementById('modal-body').textContent)}`;
            window.open(link, '_blank');
            
            // Marcar procesado
            if (dbMode === 'CLOUD') await updateContactCloud(currentContactForMail.id, { estado: 'procesado' });
            else await updateContactLocal(currentContactForMail.id, { estado: 'procesado' });
            
            closeModal();
        });

        // Helpers
        function getProgramInfo(k) {
            const map = {
                kronoPersonal: { name: 'Krono Personal', color: 'bg-blue-100 text-blue-800 border-blue-200' },
                kronoDual: { name: 'KronoDual', color: 'bg-purple-100 text-purple-800 border-purple-200' },
                tracksTelemetry: { name: 'Tracks Telemetry', color: 'bg-orange-100 text-orange-800 border-orange-200' }
            };
            return map[k] || { name: 'Otro', color: 'bg-gray-100' };
        }
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Start
        initApp();

    </script>
</body>
</html>
