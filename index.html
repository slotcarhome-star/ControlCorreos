<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Car Home - Gestor Inteligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-10">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="users" class="h-6 w-6 text-yellow-400"></i>
                <div>
                    <h1 class="text-lg font-bold leading-none">Slot Car Home</h1>
                    <div class="flex items-center gap-1 text-xs mt-1" id="connection-badge">
                        <i data-lucide="loader-2" class="h-3 w-3 animate-spin"></i> 
                        <span id="connection-text">Iniciando...</span>
                    </div>
                </div>
            </div>
            <button id="btn-toggle-view" class="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition border border-slate-700 flex items-center gap-2 text-sm font-medium">
                <i data-lucide="settings" class="h-4 w-4"></i> 
                <span id="view-text">Editar Plantillas</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-3xl mx-auto p-4 relative">
        
        <!-- VISTA: BANDEJA -->
        <div id="view-bandeja" class="flex flex-col gap-6 fade-in">
            
            <!-- ALERTA MODO LOCAL (Solo visible si no hay Firebase) -->
            <div id="local-mode-alert" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="hard-drive" class="h-5 w-5 text-blue-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Modo Local Activo:</strong> Tus datos se guardan en este navegador. 
                            <br><span class="text-xs text-blue-500">Para sincronizar en la nube, necesitar√°s configurar un proyecto de Firebase.</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- FORMULARIO -->
            <div class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-yellow-400">
                <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-2">
                    <i data-lucide="user-plus" class="h-4 w-4"></i> Nuevo Cliente
                </h2>
                <form id="form-add" class="flex flex-col gap-3">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="flex-1">
                            <input type="email" id="input-email" placeholder="Email (ej: cliente@gmail.com)" required
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none transition">
                        </div>
                        <div class="flex-1">
                            <input type="text" id="input-nombre" placeholder="Nombre (Opcional)"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none transition">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <span class="text-sm font-bold text-gray-500 pl-2">Interesado en:</span>
                        <select id="input-programa" class="flex-1 bg-transparent border-none p-2 focus:ring-0 font-medium text-slate-800 cursor-pointer outline-none">
                            <option value="kronoPersonal">üèÅ Krono Personal</option>
                            <option value="kronoDual">‚ö° KronoDual (1vs1)</option>
                            <option value="tracksTelemetry">üìä Tracks Telemetry</option>
                        </select>
                    </div>

                    <button type="submit" class="mt-1 bg-yellow-400 text-yellow-900 font-bold px-6 py-3 rounded-lg hover:bg-yellow-500 transition shadow-sm flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="h-5 w-5"></i> A√±adir a la Base de Datos
                    </button>
                </form>
            </div>

            <!-- LISTA -->
            <div>
                <div class="flex justify-between items-end mb-3 px-1">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        Cola de Env√≠os 
                        <span id="counter-pending" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">0</span>
                    </h2>
                    <button id="btn-clear-all" class="text-xs text-red-400 hover:text-red-600 flex items-center gap-1 hidden">
                        <i data-lucide="eraser" class="h-3 w-3"></i> Limpiar Todo
                    </button>
                </div>

                <div id="contacts-list" class="grid gap-3"></div>
                
                <div id="empty-state" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hidden">
                    <p class="text-gray-400 font-medium">Base de datos vac√≠a.</p>
                    <p class="text-sm text-gray-400 mt-1">A√±ade un cliente arriba para empezar.</p>
                </div>
            </div>
        </div>

        <!-- VISTA: CONFIGURACI√ìN -->
        <div id="view-config" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 pb-0">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="settings" class="h-5 w-5"></i> Editor de Plantillas
                    </h2>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="template-tabs">
                        <button data-template="kronoPersonal" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-blue-600 text-white shadow-md">
                            <i data-lucide="monitor" class="h-4 w-4"></i> Krono Personal
                        </button>
                        <button data-template="kronoDual" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <i data-lucide="zap" class="h-4 w-4"></i> KronoDual
                        </button>
                        <button data-template="tracksTelemetry" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition bg-gray-100 text-gray-600 hover:bg-gray-200">
                            <i data-lucide="activity" class="h-4 w-4"></i> Tracks Telemetry
                        </button>
                    </div>
                </div>
                
                <div class="p-6 pt-4">
                    <div class="mb-2 text-xs text-gray-500 font-medium uppercase tracking-wider" id="editor-label">
                        Editando carta para: Krono Personal
                    </div>
                    <textarea id="template-editor" class="w-full h-80 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 text-sm leading-relaxed font-mono resize-none"></textarea>
                    
                    <button id="btn-save-templates" class="mt-4 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition flex justify-center items-center gap-2">
                        <i data-lucide="save" class="h-5 w-5"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gray-800 text-white p-4 border-b flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2" id="modal-title"></h3>
                <button id="btn-close-modal" class="text-gray-400 hover:text-white transition"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <div class="border-b pb-2">
                    <span class="text-gray-500 text-xs font-bold uppercase mr-2">Para:</span>
                    <span id="modal-recipient" class="text-blue-600 bg-blue-50 px-2 py-1 rounded font-mono text-sm"></span>
                </div>
                <div id="modal-body" class="bg-gray-50 p-4 rounded-lg border text-sm whitespace-pre-wrap font-sans text-gray-700 leading-relaxed"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3 flex-wrap">
                <button id="btn-cancel-modal" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition text-sm font-medium">Cancelar</button>
                <button id="btn-copy-text" class="px-4 py-2 bg-white border text-gray-700 rounded-lg hover:bg-gray-50 transition flex items-center gap-2 text-sm shadow-sm font-medium">
                    <i data-lucide="copy" class="h-4 w-4"></i> Copiar
                </button>
                <button id="btn-send-mail" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg flex items-center gap-2 text-sm">
                    <i data-lucide="external-link" class="h-4 w-4"></i> Abrir Gmail
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SISTEMA DE ALMACENAMIENTO H√çBRIDO ---
        let dbMode = 'LOCAL'; // Por defecto, asume local hasta que se demuestre lo contrario
        let firebaseDb = null;
        let firebaseUser = null;
        let appId = 'slot-car-app';

        // Valores por defecto
        const DEFAULT_PLANTILLAS = {
            kronoPersonal: `Hola,\n\n¬°Gracias por tu inter√©s en KRONO PERSONAL!\n\nEs el gestor de tiempos ideal para entrenamientos individuales...`,
            kronoDual: `Hola,\n\n¬°Qu√© bueno que te intereses por KRONODUAL!\n\nEste es nuestro sistema dise√±ado para competiciones 1vs1...`,
            tracksTelemetry: `Hola,\n\nGracias por contactar sobre TRACKS TELEMETRY.\n\nEst√°s a punto de llevar el an√°lisis de tu pista...`
        };

        // Estado App
        let contactos = [];
        let plantillas = { ...DEFAULT_PLANTILLAS };
        let currentTemplateKey = 'kronoPersonal';
        let currentContactForMail = null;

        // Referencias DOM
        const dom = {
            badgeText: document.getElementById('connection-text'),
            badgeIcon: document.querySelector('#connection-badge i'),
            badgeContainer: document.getElementById('connection-badge'),
            localAlert: document.getElementById('local-mode-alert'),
            list: document.getElementById('contacts-list'),
            empty: document.getElementById('empty-state'),
            counter: document.getElementById('counter-pending'),
            editor: document.getElementById('template-editor'),
            viewBandeja: document.getElementById('view-bandeja'),
            viewConfig: document.getElementById('view-config'),
            modal: document.getElementById('modal-overlay')
        };

        // --- INICIALIZACI√ìN ---
        async function initApp() {
            lucide.createIcons();

            // 1. Detectar si hay configuraci√≥n de Firebase (Entorno Canvas)
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    console.log("Detectado entorno Cloud/Canvas");
                    const config = JSON.parse(__firebase_config);
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    firebaseDb = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            firebaseUser = user;
                            dbMode = 'CLOUD';
                            setConnectionStatus('cloud');
                            loadDataCloud();
                        }
                    });
                    return; // Salimos, dejamos que Firebase maneje todo
                } catch (e) {
                    console.warn("Fallo al conectar Firebase, pasando a Local", e);
                }
            }
            
            // 2. Si no hay config o fall√≥ -> MODO LOCAL AUTOM√ÅTICO
            dbMode = 'LOCAL';
            setConnectionStatus('local');
            loadDataLocal();
        }

        // --- GESTI√ìN DE UI ESTADO ---
        function setConnectionStatus(type) {
            if (type === 'cloud') {
                dom.badgeText.textContent = "Cloud Sync Activo";
                dom.badgeContainer.className = "flex items-center gap-1 text-xs text-green-400 mt-1";
                dom.badgeIcon.setAttribute('data-lucide', 'cloud');
                dom.localAlert.classList.add('hidden');
            } else {
                dom.badgeText.textContent = "Modo Local (GitHub)";
                dom.badgeContainer.className = "flex items-center gap-1 text-xs text-blue-400 mt-1";
                dom.badgeIcon.setAttribute('data-lucide', 'hard-drive');
                dom.localAlert.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // --- CAPA DE DATOS (CLOUD) ---
        function loadDataCloud() {
            // Contactos
            onSnapshot(collection(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts'), (snap) => {
                contactos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                contactos.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            });
            // Plantillas
            onSnapshot(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'settings', 'templates'), (snap) => {
                if (snap.exists()) plantillas = snap.data();
                if (!dom.viewConfig.classList.contains('hidden')) dom.editor.value = plantillas[currentTemplateKey] || "";
            });
        }

        async function addContactCloud(data) {
            await addDoc(collection(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts'), {
                ...data, createdAt: serverTimestamp()
            });
        }

        async function updateContactCloud(id, data) {
            await updateDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts', id), data);
        }

        async function deleteContactCloud(id) {
            await deleteDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'contacts', id));
        }

        async function saveTemplatesCloud() {
            await setDoc(doc(firebaseDb, 'artifacts', appId, 'users', firebaseUser.uid, 'settings', 'templates'), plantillas);
        }

        // --- CAPA DE DATOS (LOCAL) ---
        function loadDataLocal() {
            // Cargar de localStorage
            const localContacts = localStorage.getItem('slot_contacts');
            const localTemplates = localStorage.getItem('slot_templates');
            
            if (localContacts) contactos = JSON.parse(localContacts);
            if (localTemplates) plantillas = JSON.parse(localTemplates);
            
            render();
        }

        function saveLocal() {
            localStorage.setItem('slot_contacts', JSON.stringify(contactos));
            localStorage.setItem('slot_templates', JSON.stringify(plantillas));
            render();
        }

        async function addContactLocal(data) {
            const newContact = { 
                ...data, 
                id: 'local_' + Date.now(), 
                createdAt: { seconds: Date.now() / 1000 } 
            };
            contactos.unshift(newContact);
            saveLocal();
        }

        async function updateContactLocal(id, data) {
            contactos = contactos.map(c => c.id === id ? { ...c, ...data } : c);
            saveLocal();
        }

        async function deleteContactLocal(id) {
            contactos = contactos.filter(c => c.id !== id);
            saveLocal();
        }

        async function saveTemplatesLocal() {
            saveLocal(); // Las plantillas ya se actualizan en la variable global antes de llamar a esto
        }

        // --- RENDER ---
        function render() {
            dom.list.innerHTML = '';
            const pendientes = contactos.filter(c => c.estado === 'pendiente');
            dom.counter.textContent = pendientes.length;
            
            // Bot√≥n Limpiar
            const btnClear = document.getElementById('btn-clear-all');
            if(contactos.length > 0) {
                dom.empty.classList.add('hidden');
                btnClear.classList.remove('hidden');
            } else {
                dom.empty.classList.remove('hidden');
                btnClear.classList.add('hidden');
            }

            contactos.forEach(c => {
                const el = document.createElement('div');
                const info = getProgramInfo(c.programa);
                const isDone = c.estado === 'procesado';
                
                el.className = `bg-white rounded-xl p-5 shadow-sm border-l-4 transition-all ${isDone ? 'border-green-400 bg-gray-50 opacity-60' : 'border-slate-800'}`;
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg text-gray-900 leading-none">${escapeHtml(c.nombre)}</h3>
                                <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${info.color}">${info.name}</span>
                            </div>
                            <p class="text-sm text-gray-500 font-mono">${escapeHtml(c.email)}</p>
                        </div>
                        <span class="text-xs font-bold text-gray-400">${c.fecha}</span>
                    </div>
                    ${isDone ? `
                        <div class="flex items-center gap-2 text-green-700 font-bold bg-green-100 p-2 rounded-lg justify-center border border-green-200 text-sm">
                            <i data-lucide="check-circle" class="h-4 w-4"></i> Procesado
                        </div>
                    ` : `
                        <div class="flex gap-2">
                            <button onclick="window.appActions.prepare('${c.id}')" class="flex-1 bg-slate-800 text-white py-2.5 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-slate-900 shadow-md transition text-sm">
                                <i data-lucide="send" class="h-4 w-4"></i> Generar
                            </button>
                            <button onclick="window.appActions.delete('${c.id}')" class="w-10 flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg hover:text-red-500 hover:bg-red-50 transition">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    `}
                `;
                dom.list.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- HANDLERS UI ---
        document.getElementById('form-add').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const nombre = document.getElementById('input-nombre').value;
            const programa = document.getElementById('input-programa').value;
            
            if(!email) return;

            const data = {
                email, nombre: nombre || 'Usuario', programa,
                asunto: `Info: ${getProgramInfo(programa).name}`,
                fecha: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                estado: 'pendiente'
            };

            if (dbMode === 'CLOUD') await addContactCloud(data);
            else await addContactLocal(data);

            e.target.reset();
            document.getElementById('input-programa').value = programa; // Mantener selecci√≥n
        });

        // Toggle Vistas
        const btnView = document.getElementById('btn-toggle-view');
        btnView.addEventListener('click', () => {
            const isConfig = !dom.viewConfig.classList.contains('hidden');
            if (isConfig) {
                dom.viewConfig.classList.add('hidden');
                dom.viewBandeja.classList.remove('hidden');
                document.getElementById('view-text').textContent = "Editar Plantillas";
                btnView.innerHTML = `<i data-lucide="settings" class="h-4 w-4"></i> <span id="view-text">Editar Plantillas</span>`;
            } else {
                dom.viewBandeja.classList.add('hidden');
                dom.viewConfig.classList.remove('hidden');
                document.getElementById('view-text').textContent = "Volver";
                btnView.innerHTML = `<i data-lucide="arrow-left" class="h-4 w-4"></i> <span id="view-text">Volver</span>`;
                loadEditor(currentTemplateKey);
            }
            lucide.createIcons();
        });

        // Tabs Config
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => loadEditor(btn.dataset.template));
        });

        function loadEditor(key) {
            currentTemplateKey = key;
            // Estilos Tabs
            document.querySelectorAll('.tab-btn').forEach(b => {
                const active = b.dataset.template === key;
                b.className = `tab-btn px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition ${active ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
            });
            dom.editor.value = plantillas[key] || "";
            document.getElementById('editor-label').textContent = `Editando: ${getProgramInfo(key).name}`;
            lucide.createIcons();
        }

        // Guardar Plantillas
        document.getElementById('btn-save-templates').addEventListener('click', async () => {
            plantillas[currentTemplateKey] = dom.editor.value;
            if (dbMode === 'CLOUD') await saveTemplatesCloud();
            else await saveTemplatesLocal();
            
            alert('Plantilla guardada correctamente');
        });

        // Bot√≥n Limpiar Todo
        document.getElementById('btn-clear-all').addEventListener('click', async () => {
            if(confirm("¬øEst√°s seguro de borrar TODA la lista?")) {
                if(dbMode === 'LOCAL') {
                    contactos = [];
                    saveLocal();
                } else {
                    alert("En modo Cloud, por seguridad, borra uno a uno.");
                }
            }
        });

        // --- ACCIONES GLOBALES (Window) ---
        window.appActions = {
            delete: async (id) => {
                if(confirm("¬øEliminar?")) {
                    if (dbMode === 'CLOUD') await deleteContactCloud(id);
                    else await deleteContactLocal(id);
                }
            },
            prepare: (id) => {
                const c = contactos.find(x => x.id === id);
                if(!c) return;
                currentContactForMail = c;
                
                document.getElementById('modal-title').textContent = c.asunto;
                document.getElementById('modal-recipient').textContent = c.email;
                document.getElementById('modal-body').textContent = plantillas[c.programa] || "";
                dom.modal.classList.remove('hidden');
            }
        };

        // Modal Actions
        const closeModal = () => dom.modal.classList.add('hidden');
        document.getElementById('btn-close-modal').addEventListener('click', closeModal);
        document.getElementById('btn-cancel-modal').addEventListener('click', closeModal);

        document.getElementById('btn-copy-text').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('modal-body').textContent);
            alert("Copiado!");
        });

        document.getElementById('btn-send-mail').addEventListener('click', async () => {
            if (!currentContactForMail) return;
            const link = `mailto:${currentContactForMail.email}?subject=${encodeURIComponent(currentContactForMail.asunto)}&body=${encodeURIComponent(document.getElementById('modal-body').textContent)}`;
            window.open(link, '_blank');
            
            // Marcar procesado
            if (dbMode === 'CLOUD') await updateContactCloud(currentContactForMail.id, { estado: 'procesado' });
            else await updateContactLocal(currentContactForMail.id, { estado: 'procesado' });
            
            closeModal();
        });

        // Helpers
        function getProgramInfo(k) {
            const map = {
                kronoPersonal: { name: 'Krono Personal', color: 'bg-blue-100 text-blue-800 border-blue-200' },
                kronoDual: { name: 'KronoDual', color: 'bg-purple-100 text-purple-800 border-purple-200' },
                tracksTelemetry: { name: 'Tracks Telemetry', color: 'bg-orange-100 text-orange-800 border-orange-200' }
            };
            return map[k] || { name: 'Otro', color: 'bg-gray-100' };
        }
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Start
        initApp();

    </script>
</body>
</html>